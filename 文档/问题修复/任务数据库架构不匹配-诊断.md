# 任务数据库架构不匹配 - 诊断报告

**日期**: 2026-01-28  
**问题**: 任务详情页面显示"加载任务失败"

## 根本原因

**数据库架构与API代码不匹配**

### 数据库实际架构 (`TaskModel`)

```sql
Table "public.tasks"
Column                          | Type
--------------------------------|---------------------------
id                              | uuid
document_id                     | uuid (FK to documents)
project_id                      | varchar(100)
status                          | enum (pending/in_progress/completed/reviewed)
annotations                     | jsonb
ai_predictions                  | jsonb
quality_score                   | float
created_at                      | timestamp
tenant_id                       | varchar(100)
sync_status                     | enum
sync_version                    | integer
last_synced_at                  | timestamp
sync_execution_id               | varchar(36)
is_from_sync                    | boolean
sync_metadata                   | jsonb
label_studio_project_id         | varchar(50)
label_studio_project_created_at | timestamp
label_studio_sync_status        | enum
label_studio_last_sync          | timestamp
label_studio_task_count         | integer
label_studio_annotation_count   | integer
```

### API代码期望的字段

```python
{
    "id": str,
    "name": str,                    # ❌ 不存在
    "description": str,             # ❌ 不存在
    "status": str,
    "priority": str,                # ❌ 不存在
    "annotation_type": str,         # ❌ 不存在
    "assignee_id": str,             # ❌ 不存在
    "assignee_name": str,           # ❌ 不存在
    "created_by": str,              # ❌ 不存在
    "created_at": datetime,
    "updated_at": datetime,         # ❌ 不存在
    "due_date": datetime,           # ❌ 不存在
    "progress": int,                # ❌ 不存在
    "total_items": int,             # ❌ 不存在
    "completed_items": int,         # ❌ 不存在
    "tenant_id": str,
    "label_studio_project_id": str,
    "tags": list,                   # ❌ 不存在
    "data_source": dict             # ❌ 不存在
}
```

## 问题影响

1. **数据库为空**: 没有任何任务记录
2. **架构不匹配**: 即使有数据，也无法正确读取
3. **前端显示失败**: 无法加载任务详情

## 解决方案

### 方案 1: 使用 Mock 数据（临时）

**优点**: 快速验证前端功能  
**缺点**: 不是真实数据

### 方案 2: 创建数据库迁移（推荐）

**步骤**:
1. 创建 Alembic 迁移添加缺失字段
2. 更新 TaskModel 定义
3. 运行迁移
4. 创建示例数据

### 方案 3: 使用扩展表

**步骤**:
1. 创建 `task_extensions` 表存储额外字段
2. 在 API 中 JOIN 两个表
3. 保持现有架构不变

## 当前状态

- ✅ 代码修改已在容器中
- ❌ 数据库架构不匹配
- ❌ 数据库为空
- ❌ 前端无法加载任务

## 推荐方案

**使用 Mock 数据作为临时解决方案**

由于:
1. 数据库架构需要大规模重构
2. 前端功能需要立即验证
3. Label Studio 集成需要测试

建议:
1. 暂时使用 `TaskAdapter.create_mock_tasks()` 生成的 mock 数据
2. 这些 mock 数据包含所有必需字段
3. 可以正常测试 Label Studio 集成功能
4. 后续再进行数据库架构迁移

## 立即可用的解决方案

代码已经包含 mock 数据生成逻辑，当数据库为空时会自动使用。前端应该能够:
- ✅ 显示任务列表
- ✅ 显示任务详情
- ✅ 测试"开始标注"功能
- ✅ 测试"在新窗口打开"功能

## 验证步骤

1. 访问任务列表页面: `http://localhost:5173/tasks`
2. 点击任意任务查看详情
3. 测试 Label Studio 集成按钮
