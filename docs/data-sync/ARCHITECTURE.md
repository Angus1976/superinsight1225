# SuperInsight 数据同步系统 - 架构文档

## 概述

SuperInsight 数据同步系统采用"拉推并举"的双向同步架构，支持主动拉取客户数据和被动接收客户推送数据。通过智能数据治理流程，将原始数据转化为高质量的AI训练和推理数据集。

### 设计目标

- **数据质量提升**: 15-40% 准确度改善
- **响应速度优化**: 20-50% 速度提升
- **噪声数据稀释**: 通过优质行业数据集稀释低质量数据
- **智能数据增强**: 3-5倍优质样本放大

### 性能指标

| 指标 | 目标值 |
|------|--------|
| 同步吞吐量 | >10K records/second |
| 实时同步延迟 | <5 seconds |
| 系统可用性 | >99.9% |
| 故障转移时间 | <30 seconds |

## 系统架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                         External Data Sources                        │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐   │
│  │ REST API│  │Database │  │   S3    │  │Webhooks │  │  Files  │   │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘   │
└───────┼────────────┼────────────┼────────────┼────────────┼─────────┘
        │            │            │            │            │
        ▼            ▼            ▼            ▼            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        Sync Gateway Layer                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │
│  │    OAuth2    │  │     JWT      │  │   API Key    │  认证层       │
│  └──────────────┘  └──────────────┘  └──────────────┘               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │
│  │  Rate Limit  │  │   IP Filter  │  │   DDoS Prot  │  安全层       │
│  └──────────────┘  └──────────────┘  └──────────────┘               │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       Connector Layer                                │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                    Connector Pool Manager                     │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐     │    │
│  │  │REST Conn │  │DB Conn   │  │File Conn │  │CDC Conn  │     │    │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘     │    │
│  └─────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Orchestration Layer                             │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                    Sync Orchestrator                           │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐               │   │
│  │  │DAG Engine  │  │Scheduler   │  │Checkpoint  │               │   │
│  │  └────────────┘  └────────────┘  └────────────┘               │   │
│  └──────────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                    Event Manager                               │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐               │   │
│  │  │Publisher   │  │Subscriber  │  │Event Store │               │   │
│  │  └────────────┘  └────────────┘  └────────────┘               │   │
│  └──────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     Transformation Layer                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │
│  │ Field Mapper │  │Type Converter│  │ Normalizer   │  转换器       │
│  └──────────────┘  └──────────────┘  └──────────────┘               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │
│  │ Deduplicator │  │  Validator   │  │Quality Score │  清洗器       │
│  └──────────────┘  └──────────────┘  └──────────────┘               │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Conflict Resolution Layer                         │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                  Conflict Detector                             │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐               │   │
│  │  │Version     │  │Content     │  │Delete      │               │   │
│  │  │Conflict    │  │Conflict    │  │Conflict    │               │   │
│  │  └────────────┘  └────────────┘  └────────────┘               │   │
│  └──────────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                  Resolution Strategies                         │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐               │   │
│  │  │Timestamp   │  │Source      │  │Field Merge │               │   │
│  │  │Priority    │  │Priority    │  │Strategy    │               │   │
│  │  └────────────┘  └────────────┘  └────────────┘               │   │
│  └──────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      AI Dataset Layer                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │
│  │Dataset Discov│  │Dilution Eng. │  │Augment Eng.  │               │
│  └──────────────┘  └──────────────┘  └──────────────┘               │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     Real-time Communication                          │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                   WebSocket Server                             │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐               │   │
│  │  │Connection  │  │Subscription│  │Broadcast   │               │   │
│  │  │Manager     │  │Manager     │  │Engine      │               │   │
│  │  └────────────┘  └────────────┘  └────────────┘               │   │
│  └──────────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                   Stream Processor                             │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐               │   │
│  │  │Backpressure│  │Batch       │  │Dead Letter │               │   │
│  │  │Control     │  │Processor   │  │Queue       │               │   │
│  │  └────────────┘  └────────────┘  └────────────┘               │   │
│  └──────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       Monitoring Layer                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │
│  │  Prometheus  │  │   Grafana   │  │Alert Manager │               │
│  └──────────────┘  └──────────────┘  └──────────────┘               │
└─────────────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. Sync Gateway (同步网关)

负责所有数据同步请求的入口，提供统一的认证、授权和流量控制。

**主要功能**:
- OAuth2/JWT/API Key 多种认证方式
- 基于角色的访问控制 (RBAC)
- 请求速率限制和流量控制
- IP 白名单/黑名单
- DDoS 防护

**文件位置**: `src/sync/gateway/`

### 2. Connector Layer (连接器层)

管理与各类数据源的连接，支持多种数据源类型。

**支持的连接器**:
- REST API 连接器：支持多种认证方式和分页策略
- 数据库连接器：MySQL、PostgreSQL 支持
- 文件连接器：S3、本地文件系统
- CDC 连接器：MySQL Binlog、PostgreSQL WAL

**连接池管理**:
- 动态连接池大小调整
- 连接健康检查
- 自动故障转移

**文件位置**: `src/sync/connectors/`

### 3. Sync Orchestrator (同步编排器)

核心调度引擎，负责协调整个同步流程。

**主要功能**:
- DAG 工作流执行
- 任务优先级管理
- 并行执行控制
- 检查点和恢复
- 暂停/恢复/取消操作

**文件位置**: `src/sync/orchestrator/`

### 4. Transformation Layer (转换层)

数据转换和清洗引擎。

**转换器类型**:
- `FieldMappingTransformer`: 字段映射
- `TypeConversionTransformer`: 类型转换
- `ValueTransformTransformer`: 值转换 (大小写、哈希、脱敏等)
- `EnrichmentTransformer`: 数据富化
- `NormalizationTransformer`: 数据规范化 (电话、邮箱、日期)

**清洗器类型**:
- `DeduplicationEngine`: 去重引擎
- `ValidationEngine`: 验证引擎
- `QualityScore`: 质量评分

**文件位置**: `src/sync/transformer/`

### 5. Conflict Resolution (冲突解决)

处理数据同步中的冲突。

**冲突类型**:
- 版本冲突：同一记录的并发更新
- 内容冲突：不同来源的数据内容不一致
- 删除冲突：一方删除另一方更新

**解决策略**:
- 时间戳优先：最后写入获胜
- 数据源优先：特定数据源优先
- 业务规则优先：基于业务逻辑决策
- 字段级合并：合并非冲突字段

**文件位置**: `src/sync/conflict/`

### 6. WebSocket Real-time (实时通信)

支持实时数据推送和订阅。

**主要功能**:
- 连接管理和认证
- 订阅管理
- 消息广播
- 背压控制
- 断线重连

**背压策略**:
- `DROP_OLDEST`: 丢弃最旧消息
- `DROP_NEWEST`: 丢弃最新消息
- `SAMPLE`: 采样保留

**文件位置**: `src/sync/websocket/`

### 7. AI Dataset Layer (AI数据集层)

构建AI友好型数据集。

**主要功能**:
- 数据集发现和管理
- 噪声数据稀释
- 数据增强
- 质量评估

**文件位置**: `src/sync/datasets/`, `src/sync/augmentation/`

## 数据流

### 主动拉取流程

```
1. 调度器触发同步任务
2. Gateway 验证和授权
3. Connector 连接数据源
4. 分批拉取数据
5. Transformer 转换和清洗
6. Conflict Resolver 处理冲突
7. 写入目标存储
8. 发送 WebSocket 通知
```

### 被动推送流程

```
1. 客户端发送数据
2. Gateway 验证和授权
3. 数据入队
4. Stream Processor 处理
5. Transformer 转换和清洗
6. Conflict Resolver 处理冲突
7. 写入目标存储
8. 发送确认响应
```

### CDC 实时同步流程

```
1. CDC Listener 监听变更
2. 解析变更事件
3. 事件入队
4. Orchestrator 调度处理
5. Transformer 转换
6. 写入目标存储
7. 广播变更通知
```

## 高可用设计

### 故障转移

- 主备切换时间 <30 秒
- 自动健康检查间隔 10 秒
- 连接失败自动重试

### 检查点机制

- 定期保存同步位置
- 支持从检查点恢复
- 幂等性保证

### 数据一致性

- 至少一次语义
- 幂等处理支持
- 事务性写入

## 监控和告警

### 核心指标

- `sync_operations_total`: 同步操作总数
- `sync_latency_seconds`: 同步延迟
- `sync_error_rate`: 错误率
- `sync_queue_depth`: 队列深度
- `connector_pool_usage`: 连接池使用率

### 告警规则

| 告警 | 条件 | 严重级别 |
|------|------|----------|
| 高延迟 | P95 > 5s | Warning |
| 临界延迟 | P95 > 10s | Critical |
| 高错误率 | > 5% | Warning |
| 临界错误率 | > 20% | Critical |
| 队列堆积 | > 1000 | Warning |
| 连接池耗尽 | 可用 < 10% | Critical |

## 部署架构

### Kubernetes 部署

```yaml
# 典型部署配置
sync-gateway:
  replicas: 3
  resources:
    cpu: 500m
    memory: 512Mi

sync-orchestrator:
  replicas: 2
  resources:
    cpu: 1000m
    memory: 1Gi

websocket-server:
  replicas: 3
  resources:
    cpu: 500m
    memory: 256Mi
```

### 扩展策略

- Gateway: 水平扩展，无状态
- Orchestrator: 基于任务队列扩展
- WebSocket: 基于连接数扩展
- Connector: 基于数据源数量扩展

## 安全设计

### 认证

- OAuth 2.0 授权码流程
- JWT Token 认证
- API Key 认证
- HMAC 签名验证

### 数据保护

- TLS 传输加密
- 敏感数据字段加密
- 数据脱敏支持
- 审计日志记录

### 访问控制

- 基于角色的访问控制
- 资源级权限
- IP 白名单
- 请求速率限制
