# 移除假数据 - 启用真实数据库

**日期**: 2026-01-28  
**状态**: ✅ 已完成  
**优先级**: HIGH

## 问题描述

前端多个页面使用假数据（mock data），导致：
1. 编辑任务后保存使用假数据
2. 任务列表显示假数据
3. 仪表板图表显示假数据
4. 安全审计日志显示假数据

## 修复内容

### 已移除假数据的文件

#### 1. `frontend/src/pages/Tasks/TaskEdit.tsx`
- ✅ 移除 `mockTask` 定义
- ✅ 强制使用真实 `task` 数据
- ✅ 添加错误处理和重定向

#### 2. `frontend/src/pages/Tasks/index.tsx`
- ✅ 移除 `mockTasks` 数组（3个假任务）
- ✅ 更新所有引用使用 `data?.items || []`
- ✅ 修复导出功能使用真实数据
- ✅ 修复批量选择使用真实数据

#### 3. `frontend/src/pages/Tasks/TaskReview.tsx`
- ✅ 移除 `mockReviewItems` 数据
- ✅ 初始化为空数组 `[]`
- ✅ 添加 TODO 注释说明需要 API 调用

#### 4. `frontend/src/components/Dashboard/QualityReports.tsx`
- ✅ 移除所有 mock 数据（trends, distribution, workTime, anomalies）
- ✅ 使用 `data?.xxx || []` 模式
- ✅ 添加空数据保护（避免除以零）

#### 5. `frontend/src/pages/Security/index.tsx`
- ✅ 移除 `mockAuditLogs` 数据
- ✅ 移除 `mockSecurityEvents` 数据
- ✅ 初始化为空数组
- ✅ 添加 TODO 注释说明需要 API 调用

### 保留假数据的文件（需要后续处理）

#### `frontend/src/pages/Tasks/TaskCreateModal.tsx`
**原因**: 需要数据源和用户列表，但目前没有对应的 API hooks

**保留的 mock 数据**:
- `mockDataSources` - 数据源列表
- `mockUsers` - 用户列表

**TODO**:
1. 创建 `useDataSources` hook → `GET /api/data-sources`
2. 创建 `useUsers` hook → `GET /api/users`
3. 移除 mock 数据

## TypeScript 验证

```bash
cd frontend
npx tsc --noEmit
```

**结果**: ✅ 通过（无错误）

## 测试步骤

### 1. 任务编辑页面
```
访问: /tasks/{id}/edit
预期: 
- 显示真实任务数据
- 如果任务不存在，显示错误并提供返回按钮
- 保存时使用真实 API
```

### 2. 任务列表页面
```
访问: /tasks
预期:
- 显示真实任务列表（从 API 获取）
- 如果没有数据，显示空列表
- 导出功能使用真实数据
- 批量操作使用真实数据
```

### 3. 任务审核页面
```
访问: /tasks/{id}/review
预期:
- 显示空的审核列表（需要后端 API）
- 统计数据显示 0
```

### 4. 质量报告
```
访问: /dashboard (质量报告组件)
预期:
- 如果有数据，显示真实图表
- 如果没有数据，显示空图表
- 不会因为空数据而崩溃
```

### 5. 安全审计
```
访问: /security
预期:
- 显示空的审计日志列表（需要后端 API）
- 显示空的安全事件列表
- 统计数据显示 0
```

## 后续工作

### 优先级 P0（必须）

1. **创建数据源 API 和 Hook**
   ```typescript
   // frontend/src/hooks/useDataSource.ts
   export function useDataSources() {
     return useQuery({
       queryKey: ['dataSources'],
       queryFn: () => api.get<DataSource[]>('/api/data-sources'),
     });
   }
   ```

2. **创建用户列表 API 和 Hook**
   ```typescript
   // frontend/src/hooks/useUsers.ts
   export function useUsers(filters?: UserFilters) {
     return useQuery({
       queryKey: ['users', filters],
       queryFn: () => api.get<User[]>('/api/users', { params: filters }),
     });
   }
   ```

3. **创建审核项 API 和 Hook**
   ```typescript
   // frontend/src/hooks/useReview.ts
   export function useReviewItems(taskId: string) {
     return useQuery({
       queryKey: ['reviewItems', taskId],
       queryFn: () => api.get<ReviewItem[]>(`/api/tasks/${taskId}/review-items`),
     });
   }
   ```

### 优先级 P1（重要）

4. **创建质量报告 API**
   ```typescript
   // frontend/src/hooks/useQuality.ts
   export function useQualityReports(params: QualityReportParams) {
     return useQuery({
       queryKey: ['qualityReports', params],
       queryFn: () => api.get<QualityReportData>('/api/quality/reports', { params }),
     });
   }
   ```

5. **创建安全审计 API**
   ```typescript
   // frontend/src/hooks/useSecurity.ts
   export function useAuditLogs(params: AuditLogParams) {
     return useQuery({
       queryKey: ['auditLogs', params],
       queryFn: () => api.get<AuditLog[]>('/api/security/audit-logs', { params }),
     });
   }
   ```

## 影响范围

### 用户体验变化

**之前**:
- 页面总是显示假数据
- 编辑保存后数据不持久化
- 无法看到真实的系统状态

**现在**:
- 页面显示真实数据（如果有）
- 编辑保存后数据持久化到数据库
- 可以看到真实的系统状态
- 空数据时显示空列表（而不是假数据）

### 开发体验变化

**之前**:
- 开发时看到假数据，容易混淆
- 难以测试真实场景
- 假数据和真实数据不一致

**现在**:
- 开发时看到真实数据
- 容易测试真实场景
- 数据一致性更好

## 相关文档

- `文档/问题修复/标注按钮问题-修复完成.md` - TaskDetail 修复参考
- `.kiro/steering/documentation-minimalism-rules.md` - 文档规范
- `.kiro/steering/file-organization-rules.md` - 文件组织规范

## 总结

✅ **主要改进**:
1. 移除了 5 个文件中的假数据
2. 强制使用真实数据库数据
3. 添加了适当的错误处理
4. 保持了 TypeScript 类型安全

⚠️ **待完成**:
1. TaskCreateModal 仍需要数据源和用户 API
2. 需要创建 5 个新的 API hooks
3. 需要后端提供对应的 API 端点

**下一步**: 创建缺失的 API hooks 和后端端点。
