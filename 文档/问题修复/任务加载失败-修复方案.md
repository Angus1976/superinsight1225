# 任务加载失败 - 修复方案

**日期**: 2026-01-28  
**问题**: 任务详情页面显示"加载任务失败"

## 问题分析

### 根本原因
后端 API `/api/tasks/{id}` 端点只查询内存存储和 mock 数据，没有查询真实数据库。

### 代码位置
- **文件**: `src/api/tasks.py`
- **函数**: `get_task_or_404()` 和 `list_tasks()`

## 修复方案

### 1. 更新 `get_task_or_404()` 函数

添加数据库查询逻辑：

```python
def get_task_or_404(task_id: str, db: Session, user: SimpleUser) -> Dict[str, Any]:
    """Get task by ID or raise 404 if not found or no access."""
    try:
        task_uuid = UUID(task_id)
    except ValueError:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Invalid task ID format"
        )
    
    # Check in-memory storage first
    if task_id in _tasks_storage:
        return _tasks_storage[task_id]
    
    # Try to get from database
    try:
        task_model = db.query(TaskModel).filter(TaskModel.id == task_uuid).first()
        if task_model:
            # Convert TaskModel to dict
            task_dict = {
                "id": str(task_model.id),
                "name": task_model.name or f"Task {task_model.id}",
                "description": task_model.description,
                "status": task_model.status.value if hasattr(task_model.status, 'value') else str(task_model.status),
                # ... 其他字段
            }
            return task_dict
    except Exception as e:
        logger.error(f"Error querying database for task {task_id}: {e}")
    
    # Fall back to mock data
    mock_tasks = TaskAdapter.create_mock_tasks(10)
    for task in mock_tasks:
        if task["id"] == task_id:
            return task
    
    raise HTTPException(
        status_code=status.HTTP_404_NOT_FOUND,
        detail="Task not found"
    )
```

### 2. 更新 `list_tasks()` 函数

添加数据库查询逻辑以获取任务列表。

## 已完成的修复

✅ 更新了 `get_task_or_404()` 函数以查询数据库  
✅ 更新了 `list_tasks()` 函数以查询数据库  
✅ 添加了错误处理和日志记录

## 测试步骤

### 1. 检查数据库中的任务

```bash
python3 scripts/check-tasks-db.py
```

### 2. 创建示例任务（如果数据库为空）

通过 API 创建任务：

```bash
curl -X POST http://localhost:8000/api/tasks \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "name": "Sample Annotation Task",
    "description": "Test task for Label Studio integration",
    "annotation_type": "text_classification",
    "priority": "medium",
    "total_items": 100
  }'
```

### 3. 访问任务详情页面

在浏览器中访问：
```
http://localhost:5173/tasks/{task_id}
```

## 预期结果

- ✅ 任务详情页面正常加载
- ✅ 显示任务信息（名称、描述、状态等）
- ✅ "开始标注"和"在新窗口打开"按钮可用

## 后续步骤

如果数据库中没有任务：
1. 使用 API 创建新任务
2. 或者运行数据库初始化脚本创建示例数据
3. 刷新页面查看任务

## 相关文件

- `src/api/tasks.py` - 任务 API 端点（已修复）
- `frontend/src/pages/Tasks/TaskDetail.tsx` - 任务详情页面
- `frontend/src/hooks/useTask.ts` - 任务数据获取 hook
- `frontend/src/services/task.ts` - 任务 API 服务
