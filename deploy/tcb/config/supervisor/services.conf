# PostgreSQL Service
[program:postgresql]
command=/usr/lib/postgresql/15/bin/postgres -D /var/lib/postgresql/14/main -c config_file=/etc/postgresql/14/main/postgresql.conf
user=postgres
autostart=true
autorestart=true
priority=10
startsecs=10
startretries=3
stopwaitsecs=30
stdout_logfile=/var/log/supervisor/postgresql.log
stderr_logfile=/var/log/supervisor/postgresql_error.log
stdout_logfile_maxbytes=50MB
stderr_logfile_maxbytes=50MB

# Redis Service
[program:redis]
command=/usr/bin/redis-server /etc/redis/redis.conf
autostart=true
autorestart=true
priority=20
startsecs=5
startretries=3
stopwaitsecs=10
stdout_logfile=/var/log/supervisor/redis.log
stderr_logfile=/var/log/supervisor/redis_error.log
stdout_logfile_maxbytes=50MB
stderr_logfile_maxbytes=50MB

# Label Studio Service
[program:label-studio]
command=label-studio start --host 0.0.0.0 --port %(ENV_LABEL_STUDIO_PORT)s --data-dir /app/label-studio-data
directory=/app
environment=DJANGO_DB="default",POSTGRE_NAME="%(ENV_POSTGRES_DB)s",POSTGRE_USER="%(ENV_POSTGRES_USER)s",POSTGRE_PASSWORD="%(ENV_POSTGRES_PASSWORD)s",POSTGRE_HOST="localhost",POSTGRE_PORT="5432"
autostart=true
autorestart=true
priority=30
startsecs=30
startretries=3
stopwaitsecs=30
stdout_logfile=/var/log/supervisor/label-studio.log
stderr_logfile=/var/log/supervisor/label-studio_error.log
stdout_logfile_maxbytes=100MB
stderr_logfile_maxbytes=100MB

# SuperInsight API Service
[program:superinsight-api]
command=gunicorn src.app:app -w %(ENV_APP_WORKERS)s -k uvicorn.workers.UvicornWorker -b 0.0.0.0:%(ENV_APP_PORT)s --timeout 120 --graceful-timeout 30 --keep-alive 5
directory=/app
environment=PYTHONPATH="/app/src",DATABASE_URL="postgresql://%(ENV_POSTGRES_USER)s:%(ENV_POSTGRES_PASSWORD)s@localhost:5432/%(ENV_POSTGRES_DB)s",REDIS_URL="redis://localhost:6379/0",LABEL_STUDIO_URL="http://localhost:%(ENV_LABEL_STUDIO_PORT)s"
autostart=true
autorestart=true
priority=40
startsecs=15
startretries=3
stopwaitsecs=30
stdout_logfile=/var/log/supervisor/superinsight-api.log
stderr_logfile=/var/log/supervisor/superinsight-api_error.log
stdout_logfile_maxbytes=100MB
stderr_logfile_maxbytes=100MB

# Nginx Reverse Proxy
[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
priority=50
startsecs=5
startretries=3
stopwaitsecs=10
stdout_logfile=/var/log/supervisor/nginx.log
stderr_logfile=/var/log/supervisor/nginx_error.log
stdout_logfile_maxbytes=50MB
stderr_logfile_maxbytes=50MB

# Service Groups
[group:databases]
programs=postgresql,redis
priority=10

[group:applications]
programs=label-studio,superinsight-api
priority=30

[group:proxy]
programs=nginx
priority=50
