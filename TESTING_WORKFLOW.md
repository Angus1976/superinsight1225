# SuperInsight 本地测试工作流

## 📊 完整的测试工作流

```
┌─────────────────────────────────────────────────────────────────┐
│                    SuperInsight 本地测试工作流                    │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ 第一步：环境准备                                                  │
├─────────────────────────────────────────────────────────────────┤
│ 1. 复制环境配置: cp .env.example .env                            │
│ 2. 创建必要目录: mkdir -p data logs uploads exports             │
│ 3. 赋予执行权限: chmod +x start-superinsight.sh                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 第二步：启动服务                                                  │
├─────────────────────────────────────────────────────────────────┤
│ 运行: ./start-superinsight.sh                                    │
│                                                                  │
│ 启动的服务:                                                      │
│ ✓ PostgreSQL (5432)                                             │
│ ✓ Redis (6379)                                                  │
│ ✓ Neo4j (7474, 7687)                                            │
│ ✓ Label Studio (8080)                                           │
│ ✓ SuperInsight API (8000)                                       │
│                                                                  │
│ 等待时间: 30-60 秒                                               │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 第三步：验证服务                                                  │
├─────────────────────────────────────────────────────────────────┤
│ 检查命令: docker compose ps                                      │
│                                                                  │
│ 预期结果:                                                        │
│ ✓ superinsight-postgres    Up                                   │
│ ✓ superinsight-redis       Up                                   │
│ ✓ superinsight-neo4j       Up                                   │
│ ✓ superinsight-label-studio Up                                  │
│ ✓ superinsight-api         Up                                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 第四步：生成演示数据                                              │
├─────────────────────────────────────────────────────────────────┤
│ 运行: docker compose exec superinsight-api \                    │
│       python scripts/seed_demo_data.py                          │
│                                                                  │
│ 创建的数据:                                                      │
│ ✓ 6 个测试用户 (不同角色)                                        │
│ ✓ 3 个演示项目                                                   │
│ ✓ 3 个数据集                                                     │
│ ✓ 3 个标注任务                                                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 第五步：运行自动化测试                                            │
├─────────────────────────────────────────────────────────────────┤
│ 运行: bash scripts/test_all_roles.sh                            │
│                                                                  │
│ 测试项目:                                                        │
│ ✓ 服务状态检查                                                   │
│ ✓ 用户登录测试                                                   │
│ ✓ API 端点测试                                                   │
│ ✓ 权限控制测试                                                   │
│ ✓ 标注工作流测试                                                 │
│ ✓ Label Studio 集成测试                                         │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 第六步：手动测试                                                  │
├─────────────────────────────────────────────────────────────────┤
│ 访问地址:                                                        │
│ • API 文档: http://localhost:8000/docs                          │
│ • Label Studio: http://localhost:8080                           │
│ • Neo4j: http://localhost:7474                                  │
│                                                                  │
│ 测试账号:                                                        │
│ • admin / admin123                                              │
│ • business_expert / business123                                 │
│ • annotator1 / annotator123                                     │
│ • reviewer / reviewer123                                        │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 多角色测试流程

### 场景 1：系统管理员工作流

```
┌──────────────────────────────────────────────────────────┐
│ 系统管理员 (Admin)                                        │
│ 账号: admin / admin123                                   │
└──────────────────────────────────────────────────────────┘
                        ↓
        ┌───────────────┴───────────────┐
        ↓                               ↓
   ┌─────────────┐            ┌──────────────────┐
   │ 用户管理     │            │ 项目管理          │
   ├─────────────┤            ├──────────────────┤
   │ • 创建用户   │            │ • 创建项目        │
   │ • 编辑用户   │            │ • 编辑项目        │
   │ • 删除用户   │            │ • 删除项目        │
   │ • 查看用户   │            │ • 分配成员        │
   │ • 分配角色   │            │ • 查看项目        │
   └─────────────┘            └──────────────────┘
        ↓                               ↓
   ┌─────────────┐            ┌──────────────────┐
   │ 系统监控     │            │ 任务管理          │
   ├─────────────┤            ├──────────────────┤
   │ • 查看日志   │            │ • 创建任务        │
   │ • 查看指标   │            │ • 分配任务        │
   │ • 查看告警   │            │ • 查看进度        │
   │ • 系统设置   │            │ • 完成任务        │
   └─────────────┘            └──────────────────┘
```

### 场景 2：业务专家工作流

```
┌──────────────────────────────────────────────────────────┐
│ 业务专家 (Business Expert)                               │
│ 账号: business_expert / business123                      │
└──────────────────────────────────────────────────────────┘
                        ↓
        ┌───────────────┴───────────────┐
        ↓                               ↓
   ┌─────────────┐            ┌──────────────────┐
   │ 项目创建     │            │ 数据集管理        │
   ├─────────────┤            ├──────────────────┤
   │ • 新建项目   │            │ • 上传数据集      │
   │ • 编辑项目   │            │ • 查看数据集      │
   │ • 查看项目   │            │ • 删除数据集      │
   │ • 分配成员   │            │ • 导出数据集      │
   └─────────────┘            └──────────────────┘
        ↓                               ↓
   ┌─────────────┐            ┌──────────────────┐
   │ 任务创建     │            │ 任务分配          │
   ├─────────────┤            ├──────────────────┤
   │ • 创建任务   │            │ • 分配给标注员    │
   │ • 编辑任务   │            │ • 查看进度        │
   │ • 查看任务   │            │ • 调整分配        │
   │ • 删除任务   │            │ • 完成任务        │
   └─────────────┘            └──────────────────┘
```

### 场景 3：标注员工作流

```
┌──────────────────────────────────────────────────────────┐
│ 标注员 (Annotator)                                        │
│ 账号: annotator1 / annotator123                          │
└──────────────────────────────────────────────────────────┘
                        ↓
        ┌───────────────┴───────────────┐
        ↓                               ↓
   ┌─────────────┐            ┌──────────────────┐
   │ 查看任务     │            │ 执行标注          │
   ├─────────────┤            ├──────────────────┤
   │ • 查看分配   │            │ • 打开标注界面    │
   │ • 查看进度   │            │ • 标注数据        │
   │ • 查看详情   │            │ • 提交标注        │
   │ • 查看历史   │            │ • 查看反馈        │
   └─────────────┘            └──────────────────┘
        ↓                               ↓
   ┌─────────────┐            ┌──────────────────┐
   │ Label Studio │            │ 质量反馈          │
   ├─────────────┤            ├──────────────────┤
   │ • 登录       │            │ • 查看评分        │
   │ • 标注       │            │ • 查看建议        │
   │ • 导出       │            │ • 改进标注        │
   │ • 查看历史   │            │ • 重新提交        │
   └─────────────┘            └──────────────────┘
```

### 场景 4：质量审核员工作流

```
┌──────────────────────────────────────────────────────────┐
│ 质量审核员 (Reviewer)                                     │
│ 账号: reviewer / reviewer123                             │
└──────────────────────────────────────────────────────────┘
                        ↓
        ┌───────────────┴───────────────┐
        ↓                               ↓
   ┌─────────────┐            ┌──────────────────┐
   │ 审核标注     │            │ 质量管理          │
   ├─────────────┤            ├──────────────────┤
   │ • 查看待审核 │            │ • 查看质量指标    │
   │ • 审核标注   │            │ • 生成报告        │
   │ • 批准/拒绝  │            │ • 识别问题        │
   │ • 添加评论   │            │ • 改进建议        │
   └─────────────┘            └──────────────────┘
        ↓                               ↓
   ┌─────────────┐            ┌──────────────────┐
   │ 反馈管理     │            │ 统计分析          │
   ├─────────────┤            ├──────────────────┤
   │ • 发送反馈   │            │ • 查看统计        │
   │ • 跟踪改进   │            │ • 生成图表        │
   │ • 查看历史   │            │ • 导出数据        │
   │ • 生成报告   │            │ • 趋势分析        │
   └─────────────┘            └──────────────────┘
```

---

## 🧪 API 测试流程

### 步骤 1：获取 Token

```bash
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123"
  }'

# 响应:
# {
#   "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
#   "token_type": "bearer",
#   "user": {
#     "id": "...",
#     "username": "admin",
#     "email": "admin@superinsight.com",
#     "role": "admin"
#   }
# }
```

### 步骤 2：使用 Token 访问 API

```bash
TOKEN="your_token_here"

# 获取用户信息
curl -X GET http://localhost:8000/api/v1/users/me \
  -H "Authorization: Bearer $TOKEN"

# 获取项目列表
curl -X GET http://localhost:8000/api/v1/projects \
  -H "Authorization: Bearer $TOKEN"

# 获取任务列表
curl -X GET http://localhost:8000/api/v1/tasks \
  -H "Authorization: Bearer $TOKEN"

# 创建新项目
curl -X POST http://localhost:8000/api/v1/projects \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "新项目",
    "description": "项目描述"
  }'
```

### 步骤 3：使用 Swagger UI 测试

1. 访问 http://localhost:8000/docs
2. 点击右上角 "Authorize" 按钮
3. 输入用户名和密码
4. 点击 "Authorize" 按钮
5. 现在可以直接在 Swagger UI 中测试所有 API 端点

---

## 🏷️ Label Studio 测试流程

### 步骤 1：登录 Label Studio

1. 访问 http://localhost:8080
2. 输入用户名：`admin@superinsight.com`
3. 输入密码：见 `.env` 文件中的 `LABEL_STUDIO_PASSWORD`
4. 点击登录

### 步骤 2：创建项目

1. 点击 "Create" 按钮
2. 输入项目名称：`电商商品分类演示`
3. 选择标注类型：`Classification`
4. 点击 "Create" 按钮

### 步骤 3：配置标签

1. 在项目设置中配置标签：
   - 电子产品
   - 服装鞋帽
   - 食品饮料
   - 家居用品
   - 其他

### 步骤 4：导入数据

1. 创建 `sample_data.csv` 文件：
   ```csv
   text
   iPhone 13 Pro Max 256GB 深空黑色
   Adidas 运动鞋 男款 黑色
   有机咖啡豆 500g 中度烘焙
   宜家 BILLY 书架 白色
   小米 10000mAh 移动电源
   ```

2. 在 Label Studio 中导入数据：
   - 点击 "Import" 按钮
   - 选择 CSV 文件
   - 配置映射关系
   - 点击 "Import" 按钮

### 步骤 5：执行标注

1. 点击第一条数据
2. 选择对应的标签
3. 点击 "Submit" 按钮
4. 继续标注下一条数据

### 步骤 6：导出结果

1. 点击 "Export" 按钮
2. 选择导出格式（JSON、CSV 等）
3. 下载导出文件

---

## 📊 数据库测试流程

### 步骤 1：连接到数据库

```bash
docker compose exec postgres psql -U superinsight -d superinsight
```

### 步骤 2：查看表结构

```sql
-- 查看所有表
\dt

-- 查看用户表结构
\d users

-- 查看项目表结构
\d projects

-- 查看任务表结构
\d annotation_tasks
```

### 步骤 3：查询数据

```sql
-- 查看所有用户
SELECT id, username, email, role_id FROM users;

-- 查看所有项目
SELECT id, name, owner_id, status FROM projects;

-- 查看所有任务
SELECT id, name, project_id, status FROM annotation_tasks;

-- 查看用户和项目的关系
SELECT u.username, p.name 
FROM users u 
JOIN projects p ON u.id = p.owner_id;
```

### 步骤 4：修改数据

```sql
-- 更新用户信息
UPDATE users SET full_name = '新名字' WHERE username = 'admin';

-- 更新项目状态
UPDATE projects SET status = 'completed' WHERE name = '电商商品分类';

-- 删除任务
DELETE FROM annotation_tasks WHERE name = '测试任务';
```

---

## 🔍 调试技巧

### 查看实时日志

```bash
# 查看 API 日志
docker compose logs -f superinsight-api

# 查看数据库日志
docker compose logs -f postgres

# 查看 Label Studio 日志
docker compose logs -f label-studio

# 查看所有日志
docker compose logs -f
```

### 进入容器调试

```bash
# 进入 API 容器
docker compose exec superinsight-api bash

# 进入数据库容器
docker compose exec postgres bash

# 进入 Label Studio 容器
docker compose exec label-studio bash
```

### 监控资源使用

```bash
# 实时监控所有容器
docker stats

# 监控特定容器
docker stats superinsight-api
```

---

## ✅ 测试检查清单

### 基础功能
- [ ] 所有服务都在运行
- [ ] API 可以访问
- [ ] Label Studio 可以访问
- [ ] 数据库可以连接

### 认证和授权
- [ ] 可以使用正确的凭证登录
- [ ] 无法使用错误的凭证登录
- [ ] 不同角色有不同的权限
- [ ] Token 可以正确验证

### 项目管理
- [ ] 可以创建项目
- [ ] 可以编辑项目
- [ ] 可以删除项目
- [ ] 可以查看项目列表

### 标注工作流
- [ ] 可以创建标注任务
- [ ] 可以分配任务给标注员
- [ ] 标注员可以查看分配的任务
- [ ] 标注员可以执行标注
- [ ] 可以查看标注进度

### Label Studio 集成
- [ ] 可以创建 Label Studio 项目
- [ ] 可以导入数据
- [ ] 可以执行标注
- [ ] 可以导出结果
- [ ] 数据可以同步到 SuperInsight

### 质量管理
- [ ] 可以查看质量指标
- [ ] 可以生成质量报告
- [ ] 可以识别低质量标注
- [ ] 可以发送反馈

---

## 🎯 常见测试场景

### 场景 1：完整的标注工作流

1. 业务专家创建项目
2. 业务专家上传数据集
3. 业务专家创建标注任务
4. 业务专家分配任务给标注员
5. 标注员查看分配的任务
6. 标注员执行标注
7. 质量审核员审核标注
8. 生成质量报告

### 场景 2：权限控制测试

1. 以 Admin 身份创建用户
2. 以 Business Expert 身份创建项目
3. 以 Annotator 身份尝试创建项目（应该被拒绝）
4. 以 Reviewer 身份审核标注
5. 以 Annotator 身份尝试审核标注（应该被拒绝）

### 场景 3：Label Studio 集成测试

1. 在 Label Studio 中创建项目
2. 导入数据
3. 执行标注
4. 导出结果
5. 验证数据是否同步到 SuperInsight

---

## 📞 故障排查

### 问题：API 无法连接

**解决方案**：
```bash
# 检查 API 是否运行
docker compose ps superinsight-api

# 查看 API 日志
docker compose logs superinsight-api

# 重启 API
docker compose restart superinsight-api
```

### 问题：数据库连接失败

**解决方案**：
```bash
# 检查数据库是否运行
docker compose ps postgres

# 查看数据库日志
docker compose logs postgres

# 重启数据库
docker compose restart postgres
```

### 问题：Label Studio 无法访问

**解决方案**：
```bash
# 检查 Label Studio 是否运行
docker compose ps label-studio

# 查看 Label Studio 日志
docker compose logs label-studio

# 重启 Label Studio
docker compose restart label-studio
```

---

**最后更新**: 2026-01-20  
**版本**: 1.0

