# 技术常见问题解决日志

本文档记录 SuperInsight 平台开发过程中遇到的技术问题及其解决方案，供后续参考。

---

## 2026-01-28: Admin 子页面导航重定向到 Dashboard

### 问题描述
在 Admin 管理页面中，点击水平菜单项（console、tenants、workspaces、members、permissions、quotas、billing、llm-config）时，页面会重定向到 Dashboard 而不是正确导航到对应子页面。

**正常工作的页面**: users、system、概览(/admin)、配置管理及子页面(/admin/config/*)
**异常的页面**: console、tenants、workspaces、members、permissions、quotas、billing、llm-config

### 根本原因
后端认证系统存在多个问题导致 API 返回 401 错误，前端收到 401 后自动重定向到登录页：

1. **JWT 密钥不匹配**
   - `auth_simple.py` 使用 `"your-secret-key-change-in-production"`
   - `multi_tenant.py` 使用 `settings.secret_key`（默认值不同）
   - 导致 token 验证失败

2. **数据库 Schema 不匹配**
   - `get_current_user` 函数查询不存在的列（`full_name`、`tenant_id`、`role`）
   - 实际 `users` 表只有 `name`、`is_superuser` 等字段

3. **空值检查缺失**
   - `list_tenants` 端点直接访问 `current_user.role.value`
   - 当 `role` 为 `None` 时抛出异常

### 解决方案

#### 1. 统一 JWT 密钥
```python
# src/api/multi_tenant.py
# 修改前
secret_key = getattr(settings, 'secret_key', 'test-secret-key-for-local-development-only')

# 修改后
secret_key = "your-secret-key-change-in-production"  # 与 auth_simple.py 保持一致
```

#### 2. 修复数据库查询
```python
# src/api/multi_tenant.py - get_current_user 函数
# 修改前（查询不存在的列）
result = db.execute(text("""
    SELECT id, username, email, COALESCE(full_name, name) as full_name, 
           COALESCE(tenant_id, 'system') as tenant_id, is_active, 
           COALESCE(is_superuser, false) as is_superuser, role
    FROM users WHERE id = :user_id
"""), {"user_id": user_id})

# 修改后（只查询存在的列）
result = db.execute(text("""
    SELECT id, username, email, name, is_active, is_superuser
    FROM users WHERE id = :user_id
"""), {"user_id": user_id})
```

#### 3. 添加空值安全检查
```python
# src/api/multi_tenant.py - list_tenants 函数
# 修改前
if current_user.role.value == "super_admin":

# 修改后
is_super_admin = current_user.is_superuser
if not is_super_admin and current_user.role:
    role_value = current_user.role.value if hasattr(current_user.role, 'value') else str(current_user.role)
    if role_value == "super_admin":
        is_super_admin = True

if is_super_admin:
```

### 涉及文件
- `src/api/multi_tenant.py` - 主要修改
- `src/api/auth_simple.py` - 参考（JWT 密钥来源）

### 验证方法
```bash
# 1. 重启后端容器
docker compose restart app

# 2. 测试 API 认证
TOKEN=$(curl -s -X POST "http://localhost:8000/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@superinsight.local","password":"admin123"}' | \
  python3 -c "import sys, json; print(json.load(sys.stdin).get('access_token', ''))")

# 3. 测试 Admin API
curl -s -X GET "http://localhost:8000/api/v1/admin/services" \
  -H "Authorization: Bearer $TOKEN"
```

### 经验教训
1. **保持认证密钥一致性** - 所有使用 JWT 的模块必须使用相同的密钥
2. **数据库查询要匹配实际 Schema** - 使用 `\d tablename` 检查实际表结构
3. **空值安全检查** - 访问可能为 None 的属性前必须检查
4. **前端 401 处理** - 了解前端如何处理认证错误，有助于定位问题

---

## 模板：问题记录格式

```markdown
## YYYY-MM-DD: 问题标题

### 问题描述
[简要描述问题现象]

### 根本原因
[分析问题的根本原因]

### 解决方案
[具体的修复步骤和代码]

### 涉及文件
[列出修改的文件]

### 验证方法
[如何验证问题已解决]

### 经验教训
[总结可复用的经验]
```
