# Label Studio 标注导航修复 - 需求文档

**版本**: 1.0  
**创建日期**: 2026-01-28  
**状态**: 需求阶段  
**优先级**: P0 (关键)

## 1. 问题描述

### 1.1 当前问题

在任务详情页面，点击以下两个按钮时，页面重定向到仪表盘而不是跳转到 Label Studio 工作台：

1. **"开始标注"按钮** - 应该导航到 iframe 标注页面 (`/tasks/{id}/annotate`)
2. **"在新窗口打开"按钮** - 应该在新窗口打开 Label Studio 认证 URL

**影响范围**: 所有需要进行标注的任务

### 1.2 预期行为

| 按钮 | 当前行为 | 预期行为 |
|------|--------|--------|
| 开始标注 | 重定向到仪表盘 | 导航到 `/tasks/{id}/annotate` 页面，显示 Label Studio iframe |
| 在新窗口打开 | 重定向到仪表盘 | 在新浏览器窗口打开 Label Studio 项目，用户已认证 |

## 2. 用户故事

### 2.1 标注员开始标注任务

**As a** 标注员  
**I want** 点击"开始标注"按钮后能够进入标注界面  
**So that** 我可以开始对任务进行标注

**Priority**: P0  
**Acceptance Criteria** (EARS):
- WHEN 用户点击"开始标注"按钮，THEN 系统导航到 `/tasks/{id}/annotate` 页面
- WHEN 页面加载，THEN Label Studio iframe 正确加载并显示项目
- IF 项目不存在，THEN 系统自动创建项目后导航
- WHERE 项目已存在，THEN 系统直接导航到标注页面

### 2.2 在新窗口打开 Label Studio

**As a** 标注员  
**I want** 点击"在新窗口打开"按钮后在新窗口打开 Label Studio  
**So that** 我可以在独立窗口中进行标注工作

**Priority**: P0  
**Acceptance Criteria** (EARS):
- WHEN 用户点击"在新窗口打开"按钮，THEN 系统在新浏览器窗口打开 Label Studio
- WHEN 新窗口打开，THEN 用户已自动认证，无需重新登录
- WHEN 新窗口打开，THEN Label Studio 界面语言与用户当前语言一致
- IF 项目不存在，THEN 系统自动创建项目后打开新窗口
- WHERE 项目已存在，THEN 系统直接打开新窗口

## 3. 根本原因分析

### 3.1 可能的原因

1. **API 错误导致的异常处理**
   - `ensureProject` API 返回错误
   - `getAuthUrl` API 返回错误
   - 错误处理逻辑导致重定向

2. **认证问题**
   - JWT token 过期或无效
   - 请求头中缺少认证信息
   - 后端认证中间件拒绝请求

3. **导航逻辑错误**
   - `navigate()` 调用失败
   - 路由配置不正确
   - 页面加载时发生错误导致重定向

4. **API 端点问题**
   - 后端 API 端点未实现或返回错误
   - API 响应格式不匹配
   - 后端服务不可用

### 3.2 调查步骤

1. **检查浏览器控制台**
   - 查看是否有 JavaScript 错误
   - 查看网络请求是否成功
   - 查看 API 响应状态码和内容

2. **检查后端日志**
   - 查看 API 请求是否到达后端
   - 查看是否有异常或错误日志
   - 查看认证中间件是否拒绝请求

3. **检查前端代码**
   - 验证 `navigate()` 调用是否正确
   - 验证错误处理逻辑
   - 验证 API 调用参数

## 4. 非功能需求

### 4.1 性能
- 导航延迟 < 500ms
- 项目创建 < 2s
- 认证 URL 生成 < 1s

### 4.2 可靠性
- 项目创建失败时显示清晰的错误提示
- 网络错误时支持重试
- 认证失败时提示用户重新登录

### 4.3 用户体验
- 加载过程中显示加载指示器
- 错误时显示可操作的错误提示
- 支持快捷键或其他快速操作方式

## 5. 依赖关系

### 5.1 前置条件
- 用户已登录
- 任务已创建
- Label Studio 服务可用

### 5.2 相关功能
- 任务详情页面 (`TaskDetail.tsx`)
- 标注页面 (`TaskAnnotate.tsx`)
- Label Studio 集成服务 (`labelStudioService.ts`)
- 后端 Label Studio API (`src/api/label_studio_api.py`)

## 6. 验收标准

### 6.1 功能验收

- [ ] "开始标注"按钮点击后成功导航到 `/tasks/{id}/annotate`
- [ ] "在新窗口打开"按钮点击后在新窗口打开 Label Studio
- [ ] 项目不存在时自动创建项目
- [ ] 项目已存在时直接导航/打开
- [ ] 错误时显示清晰的错误提示
- [ ] 语言切换时 Label Studio 界面语言同步

### 6.2 测试覆盖

- [ ] 单元测试: 按钮点击处理逻辑
- [ ] 集成测试: API 调用和导航流程
- [ ] E2E 测试: 完整的用户操作流程
- [ ] 错误场景测试: 各种错误情况的处理

### 6.3 文档

- [ ] 更新 API 文档
- [ ] 更新前端组件文档
- [ ] 更新故障排查指南

## 7. 风险评估

### 7.1 技术风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|--------|
| API 端点不可用 | 中 | 高 | 添加健康检查和重试逻辑 |
| 认证失败 | 中 | 高 | 改进错误处理和日志 |
| 浏览器兼容性 | 低 | 中 | 测试主流浏览器 |

### 7.2 业务风险

- 用户无法进行标注工作
- 影响标注效率和项目进度

## 8. 相关文档

- [Label Studio 企业版 Workspace 扩展设计](../label-studio-enterprise-workspace/design.md)
- [Label Studio iframe 集成规范](../label-studio-iframe-integration/design.md)
- [技术常见问题解决日志](../../文档/问题修复/技术常见问题解决日志.md)

---

**下一步**: 创建设计文档 (design.md)
