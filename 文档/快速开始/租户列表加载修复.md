# 租户列表加载修复

**日期**: 2026-01-28  
**问题**: 登录后显示"加载租户列表失败"  
**状态**: ✅ 已修复

## 问题描述

管理员用户登录后，登录表单显示错误：
```
Failed to load tenants: Error
```

这导致租户选择下拉菜单无法显示，影响登录流程。

## 根本原因

前端 `LoginForm.tsx` 在挂载时调用 `authService.getTenants()` 来加载可用租户列表。

该方法调用的端点：
```
GET /api/auth/tenants
```

但是后端使用的是 `auth_simple.py`，该文件中**没有实现** `/tenants` 端点。

虽然 `src/api/auth.py` 中有该端点的实现，但它没有被加载到应用中（应用只加载了 `auth_simple.py`）。

## 解决方案

在 `src/api/auth_simple.py` 中添加 `/tenants` 端点实现：

```python
@router.get("/tenants")
def get_tenants(db: Session = Depends(get_db_session)):
    """Get available tenants for login."""
    try:
        # Try to query from multi_tenant_models if available
        try:
            from src.database.multi_tenant_models import TenantModel, TenantStatus
            
            # Query active tenants from database
            tenants = db.query(TenantModel).filter(
                TenantModel.status == TenantStatus.ACTIVE
            ).all()
            
            if tenants:
                return [
                    {
                        "id": tenant.id,
                        "name": tenant.display_name or tenant.name,
                        "logo": tenant.configuration.get("logo") if tenant.configuration else None
                    }
                    for tenant in tenants
                ]
        except (ImportError, Exception) as e:
            logger.debug(f"Could not query from TenantModel: {e}")
        
        # Fallback to default tenant
        return [
            {
                "id": "default_tenant",
                "name": "Default Tenant",
                "logo": None
            }
        ]
    except Exception as e:
        logger.warning(f"Failed to get tenants: {e}")
        # Return default tenant on error
        return [
            {
                "id": "default_tenant",
                "name": "Default Tenant",
                "logo": None
            }
        ]
```

## 功能说明

- **优先级 1**: 尝试从数据库查询活跃租户
- **优先级 2**: 如果数据库查询失败，返回默认租户
- **容错机制**: 任何异常都会返回默认租户，确保端点不会失败

## 测试结果

✅ 端点测试通过：
```bash
$ curl http://localhost:8000/api/auth/tenants
[{"id":"default_tenant","name":"Default Tenant","logo":null}]
```

✅ 完整登录流程测试通过：
1. 获取租户列表 ✅
2. 登录 ✅
3. 获取用户信息 ✅

## 修改文件

- `src/api/auth_simple.py` - 添加 `/tenants` 端点

## Git 提交

```
Commit: 840f6a4
Message: Fix: Add tenant endpoint to auth_simple.py for frontend tenant list loading
```

## 现在可以做什么

1. ✅ 登录表单可以加载租户列表
2. ✅ 如果有多个租户，可以在登录时选择
3. ✅ 如果没有租户，使用默认租户
4. ✅ 登录后可以访问管理员功能

## 下一步

如果需要添加更多租户，可以通过以下方式：
1. 直接在数据库中添加租户记录
2. 或通过 `/api/v1/admin/tenants` 端点创建租户（如果已实现）
