# 标注按钮功能测试指南

## 测试环境
- 前端: http://localhost:5173
- 后端 API: http://localhost:8000
- Label Studio: http://localhost:8080

## 测试准备

### 1. 确认服务状态
```bash
docker compose ps
```

所有服务应该显示为 "Up" 和 "healthy" 状态。

### 2. 登录系统
1. 访问 http://localhost:5173
2. 使用管理员账号登录
3. 进入任务管理页面

## 测试场景

### 场景 1: "开始标注" 按钮测试

#### 测试步骤：
1. **进入任务详情页**
   - 在任务列表中选择一个任务
   - 点击任务名称进入详情页

2. **点击"开始标注"按钮**
   - 位置：任务详情页右上角
   - 图标：播放图标 (PlayCircleOutlined)
   - 文本：中文显示"开始标注"，英文显示"Start Annotation"

3. **预期行为**：
   - ✅ 按钮显示加载状态（转圈图标）
   - ✅ 如果项目不存在，显示提示"正在创建项目..."
   - ✅ 自动创建 Label Studio 项目
   - ✅ 页面跳转到 `/tasks/{id}/annotate`
   - ✅ 显示嵌入式 Label Studio 标注界面

4. **错误处理测试**：
   - 如果 Label Studio 服务未启动：
     - ✅ 显示错误消息"服务不可用"
   - 如果认证失败：
     - ✅ 显示错误消息"认证失败"

#### 验证点：
- [ ] 按钮可点击且响应正常
- [ ] 加载状态正确显示
- [ ] 项目自动创建成功
- [ ] 页面跳转正确
- [ ] 标注界面正常加载
- [ ] 错误消息清晰明确

---

### 场景 2: "在新窗口打开" 按钮测试

#### 测试步骤：
1. **进入任务详情页**
   - 在任务列表中选择一个任务
   - 点击任务名称进入详情页

2. **点击"在新窗口打开"按钮**
   - 位置：任务详情页右上角，"开始标注"按钮旁边
   - 图标：导出图标 (ExportOutlined)
   - 文本：中文显示"在新窗口打开"，英文显示"Open in New Window"

3. **预期行为**：
   - ✅ 按钮显示加载状态（转圈图标）
   - ✅ 如果项目不存在，显示提示"正在创建项目..."
   - ✅ 自动创建 Label Studio 项目
   - ✅ 获取带认证的 URL
   - ✅ 在新窗口打开 Label Studio
   - ✅ 新窗口自动使用用户的语言偏好（中文/英文）

4. **语言偏好测试**：
   - 切换系统语言为中文：
     - ✅ 新窗口的 Label Studio 界面显示中文
   - 切换系统语言为英文：
     - ✅ 新窗口的 Label Studio 界面显示英文

5. **错误处理测试**：
   - 如果 Label Studio 服务未启动：
     - ✅ 显示错误消息"服务不可用"
   - 如果认证失败：
     - ✅ 显示错误消息"认证失败"

#### 验证点：
- [ ] 按钮可点击且响应正常
- [ ] 加载状态正确显示
- [ ] 项目自动创建成功
- [ ] 新窗口成功打开
- [ ] Label Studio 界面正常显示
- [ ] 语言偏好正确应用
- [ ] 认证 URL 正常工作
- [ ] 错误消息清晰明确

---

## 测试用例矩阵

| 场景 | 项目状态 | 预期结果 | 测试状态 |
|------|---------|---------|---------|
| 开始标注 - 项目已存在 | 存在且可访问 | 直接跳转到标注页面 | ⬜ |
| 开始标注 - 项目不存在 | 不存在 | 创建项目后跳转 | ⬜ |
| 开始标注 - 项目不可访问 | 存在但不可访问 | 重新创建项目后跳转 | ⬜ |
| 开始标注 - 服务不可用 | N/A | 显示错误消息 | ⬜ |
| 新窗口打开 - 项目已存在 | 存在且可访问 | 直接打开新窗口 | ⬜ |
| 新窗口打开 - 项目不存在 | 不存在 | 创建项目后打开新窗口 | ⬜ |
| 新窗口打开 - 中文界面 | 存在 | 新窗口显示中文 | ⬜ |
| 新窗口打开 - 英文界面 | 存在 | 新窗口显示英文 | ⬜ |
| 新窗口打开 - 服务不可用 | N/A | 显示错误消息 | ⬜ |

---

## 调试技巧

### 1. 查看浏览器控制台
```
F12 或 Cmd+Option+I (Mac)
```
- 检查是否有 JavaScript 错误
- 查看网络请求状态
- 检查 API 响应内容

### 2. 查看后端日志
```bash
docker compose logs -f app
```
- 检查 API 请求日志
- 查看错误堆栈信息
- 验证 Label Studio 集成状态

### 3. 查看 Label Studio 日志
```bash
docker compose logs -f label-studio
```
- 检查项目创建日志
- 查看认证请求
- 验证 API 调用

### 4. 测试 API 端点
```bash
# 验证项目
curl -X POST http://localhost:8000/api/v1/label-studio/validate-project \
  -H "Content-Type: application/json" \
  -d '{"project_id": "1"}'

# 确保项目存在
curl -X POST http://localhost:8000/api/v1/label-studio/ensure-project \
  -H "Content-Type: application/json" \
  -d '{
    "task_id": "test-task-1",
    "task_name": "测试任务",
    "annotation_type": "text_classification"
  }'

# 获取认证 URL
curl -X POST http://localhost:8000/api/v1/label-studio/auth-url \
  -H "Content-Type: application/json" \
  -d '{
    "project_id": "1",
    "language": "zh"
  }'
```

---

## 常见问题排查

### 问题 1: 按钮点击无响应
**可能原因**：
- JavaScript 错误
- API 服务未启动
- 网络请求被阻止

**解决方法**：
1. 检查浏览器控制台错误
2. 验证后端服务状态：`docker compose ps`
3. 检查网络请求：F12 → Network 标签

### 问题 2: 项目创建失败
**可能原因**：
- Label Studio 服务未启动
- 认证配置错误
- 数据库连接问题

**解决方法**：
1. 检查 Label Studio 状态：`docker compose ps label-studio`
2. 查看后端日志：`docker compose logs app`
3. 验证环境变量配置

### 问题 3: 新窗口打开失败
**可能原因**：
- 浏览器阻止弹窗
- 认证 URL 生成失败
- CORS 配置问题

**解决方法**：
1. 允许浏览器弹窗
2. 检查认证 URL 格式
3. 验证 CORS 配置

### 问题 4: 语言偏好不生效
**可能原因**：
- 语言参数未传递
- Label Studio 不支持该语言
- URL 参数格式错误

**解决方法**：
1. 检查 API 请求参数
2. 验证 Label Studio 语言支持
3. 查看生成的 URL 格式

---

## 测试报告模板

### 测试执行日期：____________________

### 测试人员：____________________

### 测试结果：

#### 场景 1: "开始标注" 按钮
- [ ] 通过
- [ ] 失败
- 备注：_________________________________

#### 场景 2: "在新窗口打开" 按钮
- [ ] 通过
- [ ] 失败
- 备注：_________________________________

### 发现的问题：
1. _________________________________
2. _________________________________
3. _________________________________

### 建议改进：
1. _________________________________
2. _________________________________
3. _________________________________

---

## 下一步

测试完成后，请：
1. ✅ 填写测试报告
2. ✅ 记录发现的问题
3. ✅ 提交 Bug 报告（如有）
4. ✅ 更新文档（如需要）

