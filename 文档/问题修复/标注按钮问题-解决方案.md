# 标注按钮重定向问题 - 解决方案

**日期**: 2026-01-28  
**问题**: 点击"开始标注"和"在新窗口打开"按钮重定向到dashboard  
**根本原因**: `useParams()` 返回 `undefined`，导致使用mockTask数据，mockTask中的假项目ID导致API调用失败

## 问题分析

### 错误链路

```
1. URL: /tasks/4df6cdb8fc-79c0-41ae-1a7a-fc4c67225d1a
2. useParams() 返回: { id: undefined }  ← 问题根源
3. useTask(undefined) 被禁用 (enabled: !!id)
4. task = undefined
5. currentTask = mockTask  ← 使用假数据
6. mockTask.label_studio_project_id = 'ls-project-123'  ← 假的项目ID
7. 点击按钮 → 调用API验证项目
8. API返回404/500错误
9. 抛出异常
10. ErrorBoundary捕获
11. 重定向到 / → /dashboard
```

### 证据

**Network标签**（截图1）：
- `GET /api/tasks/undefined` → 404
- 说明 `id` 是 `undefined`

**Console错误**（截图2）：
- `Cannot read properties of undefined (reading 'ProtectedRoute')`
- 可能是路由系统初始化问题

**页面显示**（截图2）：
- 显示了任务详情
- 但使用的是mockTask数据
- mockTask.id = id || '1' = '1'（因为id是undefined）

## 解决方案

### 方案1: 修复useParams问题（推荐）

**问题**: `useParams()` 在某些情况下返回 `undefined`

**可能原因**:
1. React Router版本不兼容
2. 组件渲染时机问题
3. 路由配置问题

**修复步骤**:

#### 步骤1: 添加调试日志

修改 `frontend/src/pages/Tasks/TaskDetail.tsx`:

```typescript
const TaskDetailPage: React.FC = () => {
  const params = useParams<{ id: string }>();
  const { id } = params;
  
  // 添加调试日志
  console.log('[TaskDetail] useParams result:', params);
  console.log('[TaskDetail] id:', id);
  console.log('[TaskDetail] typeof id:', typeof id);
  
  const navigate = useNavigate();
  const { t } = useTranslation('tasks');
  
  // 确保id不是undefined
  if (!id) {
    console.error('[TaskDetail] ID is undefined, redirecting to tasks list');
    return <Navigate to="/tasks" replace />;
  }
  
  const { data: task, isLoading, error } = useTask(id);
  // ... 其余代码
```

#### 步骤2: 检查React Router版本

```bash
cd frontend
npm list react-router-dom
```

如果版本低于6.4，升级：

```bash
npm install react-router-dom@latest
```

#### 步骤3: 确保路由正确嵌套

检查 `frontend/src/router/routes.tsx` 中的路由配置是否正确。

### 方案2: 使用window.location作为后备（临时）

如果useParams失败，从URL直接解析ID：

```typescript
const TaskDetailPage: React.FC = () => {
  const params = useParams<{ id: string }>();
  const location = useLocation();
  
  // 从useParams获取ID
  let id = params.id;
  
  // 如果useParams失败，从URL解析
  if (!id) {
    const pathParts = location.pathname.split('/');
    const taskIndex = pathParts.indexOf('tasks');
    if (taskIndex >= 0 && pathParts[taskIndex + 1]) {
      id = pathParts[taskIndex + 1];
      console.warn('[TaskDetail] useParams failed, parsed ID from URL:', id);
    }
  }
  
  console.log('[TaskDetail] Final ID:', id);
  
  if (!id) {
    return <Navigate to="/tasks" replace />;
  }
  
  const { data: task, isLoading, error } = useTask(id);
  // ... 其余代码
```

### 方案3: 移除mockTask依赖（推荐）

不要在生产环境使用mockTask：

```typescript
const TaskDetailPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  
  if (!id) {
    return <Navigate to="/tasks" replace />;
  }
  
  const { data: task, isLoading, error } = useTask(id);
  
  if (isLoading) {
    return (
      <Card>
        <Skeleton active paragraph={{ rows: 10 }} />
      </Card>
    );
  }
  
  if (error || !task) {
    return (
      <Alert
        type="error"
        message={t('failedToLoadTask')}
        description={t('failedToLoadTaskDescription')}
        showIcon
        action={
          <Button onClick={() => navigate('/tasks')}>
            返回任务列表
          </Button>
        }
      />
    );
  }
  
  // 使用真实的task数据
  const currentTask = task;
  
  // ... 其余代码
```

## 立即修复步骤

### 步骤1: 应用方案1和方案2的组合修复

创建修复文件：

```bash
# 备份原文件
cp frontend/src/pages/Tasks/TaskDetail.tsx frontend/src/pages/Tasks/TaskDetail.tsx.backup

# 应用修复
```

修改 `frontend/src/pages/Tasks/TaskDetail.tsx`:

```typescript
import { useState } from 'react';
import { useParams, useNavigate, useLocation, Navigate } from 'react-router-dom';
// ... 其他导入

const TaskDetailPage: React.FC = () => {
  const params = useParams<{ id: string }>();
  const location = useLocation();
  const navigate = useNavigate();
  const { t } = useTranslation('tasks');
  
  // 获取ID，带后备方案
  let id = params.id;
  
  // 调试日志
  console.log('[TaskDetail] useParams:', params);
  console.log('[TaskDetail] location.pathname:', location.pathname);
  
  // 如果useParams失败，从URL解析
  if (!id) {
    const pathParts = location.pathname.split('/');
    const taskIndex = pathParts.indexOf('tasks');
    if (taskIndex >= 0 && pathParts[taskIndex + 1]) {
      id = pathParts[taskIndex + 1];
      console.warn('[TaskDetail] useParams failed, using URL parsing. ID:', id);
    }
  }
  
  console.log('[TaskDetail] Final ID:', id);
  
  // 如果仍然没有ID，重定向到任务列表
  if (!id || id === 'undefined') {
    console.error('[TaskDetail] No valid ID found, redirecting to tasks list');
    return <Navigate to="/tasks" replace />;
  }
  
  const { data: task, isLoading, error } = useTask(id);
  const { annotation: annotationPerms } = usePermissions();
  const updateTask = useUpdateTask();
  const deleteTask = useDeleteTask();
  
  // 移除mockTask，强制使用真实数据
  // const mockTask = { ... };  // 删除这部分
  
  // Loading state for annotation operations
  const [annotationLoading, setAnnotationLoading] = useState(false);
  const [openWindowLoading, setOpenWindowLoading] = useState(false);
  
  // Get user's language preference
  const { language } = useLanguageStore();
  
  // ... handleAnnotationError 函数保持不变
  
  // 修改handleStartAnnotation，确保使用真实的task数据
  const handleStartAnnotation = async () => {
    if (!id || !task) {
      console.error('[handleStartAnnotation] Task ID or task data is missing');
      message.error('任务数据加载失败，请刷新页面重试');
      return;
    }
    
    try {
      setAnnotationLoading(true);
      console.log('[handleStartAnnotation] Starting...', { taskId: id, task });
      
      // 使用真实的task数据
      const projectId = task.label_studio_project_id;
      console.log('[handleStartAnnotation] Current project ID:', projectId);
      
      // ... 其余逻辑保持不变，但使用task而不是currentTask
      
    } catch (error) {
      handleAnnotationError(error, 'handleStartAnnotation');
    } finally {
      setAnnotationLoading(false);
    }
  };
  
  // 类似地修改handleOpenInNewWindow
  const handleOpenInNewWindow = async () => {
    if (!id || !task) {
      console.error('[handleOpenInNewWindow] Task ID or task data is missing');
      message.error('任务数据加载失败，请刷新页面重试');
      return;
    }
    
    // ... 使用task而不是currentTask
  };
  
  // Loading状态
  if (isLoading) {
    return (
      <Card>
        <Skeleton active paragraph={{ rows: 10 }} />
      </Card>
    );
  }
  
  // 错误状态
  if (error || !task) {
    return (
      <Alert
        type="error"
        message={t('failedToLoadTask')}
        description={error?.message || t('failedToLoadTaskDescription')}
        showIcon
        action={
          <Button type="primary" onClick={() => navigate('/tasks')}>
            返回任务列表
          </Button>
        }
      />
    );
  }
  
  // 使用真实的task数据
  const currentTask = task;
  
  // ... 其余渲染逻辑保持不变
};
```

### 步骤2: 重新构建前端

```bash
cd frontend

# 清除缓存
rm -rf node_modules/.vite
rm -rf dist

# 重新构建
npm run build

# 或重启开发服务器
npm run dev
```

### 步骤3: 硬刷新浏览器

在浏览器中按 `Ctrl+Shift+R` (Windows/Linux) 或 `Cmd+Shift+R` (Mac) 硬刷新页面。

### 步骤4: 测试

1. 访问任务列表页面
2. 点击任何一个任务
3. 检查Console是否有 `[TaskDetail]` 开头的日志
4. 确认ID是否正确获取
5. 点击"开始标注"按钮
6. 检查是否正常工作

## 预期结果

修复后，Console应该显示：

```
[TaskDetail] useParams: {id: "4df6cdb8fc-79c0-41ae-1a7a-fc4c67225d1a"}
[TaskDetail] location.pathname: "/tasks/4df6cdb8fc-79c0-41ae-1a7a-fc4c67225d1a"
[TaskDetail] Final ID: 4df6cdb8fc-79c0-41ae-1a7a-fc4c67225d1a
[handleStartAnnotation] Starting... {taskId: "4df6cdb8fc-79c0-41ae-1a7a-fc4c67225d1a", task: {...}}
```

## 如果问题仍然存在

如果修复后问题仍然存在，请提供：

1. 新的Console日志（包含 `[TaskDetail]` 日志）
2. Network标签中的API请求
3. React Router版本号

## 相关文件

- `frontend/src/pages/Tasks/TaskDetail.tsx` - 需要修改的主文件
- `frontend/src/hooks/useTask.ts` - Task数据获取hook
- `frontend/src/router/routes.tsx` - 路由配置

## 后续优化

修复后，建议：

1. 移除所有mockTask相关代码
2. 添加更好的错误处理
3. 添加加载状态提示
4. 添加数据验证
